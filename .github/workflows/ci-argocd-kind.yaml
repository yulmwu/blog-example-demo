name: ArgoCD CI with Kind

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  argocd-kind-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Set up kind
        uses: helm/kind-action@v1
        with:
          cluster_name: argocd-ci-cluster
          kubectl_version: 'v1.33.0'

      - name: Install ArgoCD
        run: |
          kubectl create namespace argocd
          kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

      - name: Wait for ArgoCD components to be ready
        run: |
          kubectl wait --namespace argocd \
            --for=condition=Available deployment/argocd-redis \
            --timeout=120s
          kubectl wait --namespace argocd \
            --for=condition=Available deployment/argocd-server \
            --timeout=120s
          kubectl wait --namespace argocd \
            --for=condition=Available deployment/argocd-repo-server \
            --timeout=120s
          kubectl wait --namespace argocd \
            --for=condition=Available deployment/argocd-dex-server \
            --timeout=120s
          kubectl wait --namespace argocd \
            --for=condition=Available deployment/argocd-applicationset-controller \
            --timeout=120s
          kubectl wait --namespace argocd \
            --for=condition=Available deployment/argocd-notifications-controller \
            --timeout=120s

      - name: Apply ArgoCD Application
        run: |
          kubectl apply -f main/k8s-argocd-ci-example/argocd/application.yaml

      - name: Wait for ArgoCD Application Sync & Healthy
        run: |
          APP_NAME="demo-app"
          NAMESPACE="argocd"

          echo "Waiting for ArgoCD Application/${APP_NAME} to be Synced and Healthy..."

          for i in {1..10}; do
            SYNC_STATUS=$(kubectl get application ${APP_NAME} -n ${NAMESPACE} -o jsonpath='{.status.sync.status}' || echo "Unknown")
            HEALTH_STATUS=$(kubectl get application ${APP_NAME} -n ${NAMESPACE} -o jsonpath='{.status.health.status}' || echo "Unknown")

            echo "Try ${i}: sync=${SYNC_STATUS}, health=${HEALTH_STATUS}"

            if [ "$SYNC_STATUS" = "Synced" ] && [ "$HEALTH_STATUS" = "Healthy" ]; then
              echo "Application is Synced and Healthy"
              exit 0
            fi

            sleep 5
          done

          echo "Application did not become Synced/Healthy in time"
          kubectl get application ${APP_NAME} -n ${NAMESPACE} -o yaml || true
          kubectl get pods -A || true

          exit 1

      - name: Clean up
        if: always()
        run: |
          kind delete cluster --name argocd-ci-cluster
